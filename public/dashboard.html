<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>後台管理</title>
</head>
<body>
  <h1>後台管理</h1>
  <div id="currentUser"></div>
  <button onclick="logout()">登出</button>
  <a href="/">返回首頁</a>

  <h2>活動與款項</h2>
  <div id="activities"></div>

  <script>
    async function loadCurrentUser() {
      const res = await fetch("/api/current-user");
      const data = await res.json();
      if (data.username) {
        document.getElementById("currentUser").innerText = "目前登入：" + data.username;
      } else {
        window.location.href = "/login.html";
      }
    }

    async function loadActivities() {
      const res = await fetch("/api/activities");
      const activities = await res.json();
      const container = document.getElementById("activities");
      container.innerHTML = "";
      activities.forEach(act => {
        const div = document.createElement("div");
        div.innerHTML = `<h3>${act.name} - 申請人：${act.applicant} (${act.applyDate})</h3>`;
        const table = document.createElement("table");
        table.border = 1;
        table.innerHTML = `<tr>
          <th>用途</th><th>金額</th><th>來源</th><th>狀態</th>
          <th>申請日</th><th>給款日</th><th>還款日</th><th>學校補助</th><th>學生會補助</th><th>剩餘現金</th><th>操作</th>
        </tr>`;
        act.items.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.description}</td>
            <td>${item.amount}</td>
            <td>${item.source}</td>
            <td>${item.status}</td>
            <td>${item.applyDate}</td>
            <td>${item.payDate || ""}</td>
            <td>${item.repayDate || ""}</td>
            <td>${item.schoolSubsidy}</td>
            <td>${item.studentUnionSubsidy}</td>
            <td>${item.cashReturn}</td>
            <td>
              ${item.status === "申請中" ? `<button onclick="pay(${act.id},${item.id})">已付款</button>` : ""}
              ${item.status === "已付款" ? `<button onclick="repayPrompt(${act.id},${item.id})">還款</button>` : ""}
            </td>
          `;
          table.appendChild(tr);
        });
        div.appendChild(table);
        container.appendChild(div);
      });
    }

    async function pay(activityId, itemId) {
      await fetch(`/api/activity/${activityId}/item/${itemId}/pay`, { method: "POST" });
      loadActivities();
    }

    async function repayPrompt(activityId, itemId) {
      const schoolSubsidy = prompt("輸入學校補助金額：", "0");
      const studentUnionSubsidy = prompt("輸入學生會補助金額：", "0");
      if (schoolSubsidy !== null && studentUnionSubsidy !== null) {
        await fetch(`/api/activity/${activityId}/item/${itemId}/repay`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ schoolSubsidy, studentUnionSubsidy })
        });
        loadActivities();
      }
    }

    async function logout() {
      await fetch("/logout");
      window.location.href = "/login.html";
    }

    loadCurrentUser();
    loadActivities();
  </script>
</body>
</html>
