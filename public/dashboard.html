<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>後台管理</title>
</head>
<body>
  <h1>後台管理</h1>
  <div id="currentUser"></div>
  <button onclick="logout()">登出</button>
  <a href="/">返回首頁</a>

  <h2>活動列表</h2>
  <div id="activities"></div>

  <script>
    async function loadCurrentUser() {
      const res = await fetch("/api/current-user");
      const data = await res.json();
      if (data.username) {
        document.getElementById("currentUser").innerText = "目前登入：" + data.username;
      } else {
        window.location.href = "/login.html";
      }
    }

    async function loadActivities() {
      const res = await fetch("/api/activities");
      const acts = await res.json();
      const container = document.getElementById("activities");
      container.innerHTML = "";
      acts.forEach(act => {
        const div = document.createElement("div");
        div.innerHTML = `<h3>${act.name} - 申請人：${act.applicant} (${act.applyDate})</h3>
          <button onclick="payActivity(${act.id})">給款</button>
          <button onclick="repayActivity(${act.id})">還款</button>`;
        const table = document.createElement("table");
        table.border = 1;
        table.innerHTML = `<tr>
          <th>用途</th><th>金額</th><th>來源</th><th>狀態</th>
          <th>申請日</th><th>給款日</th><th>還款日</th>
          <th>學校補助</th><th>學生會補助</th><th>剩餘現金</th>
        </tr>`;
        act.items.forEach(it => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${it.description}</td><td>${it.amount}</td><td>${it.source}</td>
            <td>${it.status}</td><td>${it.applyDate}</td><td>${it.payDate||""}</td><td>${it.repayDate||""}</td>
            <td>${it.schoolSubsidy}</td><td>${it.studentUnionSubsidy}</td><td>${it.cashReturn}</td>`;
          table.appendChild(tr);
        });
        div.appendChild(table);
        container.appendChild(div);
      });
    }

    async function payActivity(id) {
      await fetch(`/api/activity/${id}/pay`, { method: "POST" });
      loadActivities();
    }

    async function repayActivity(id) {
      const schoolSubsidy = prompt("輸入學校補助金額：", "0");
      const studentUnionSubsidy = prompt("輸入學生會補助金額：", "0");
      if (schoolSubsidy !== null && studentUnionSubsidy !== null) {
        await fetch(`/api/activity/${id}/repay`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ schoolSubsidy, studentUnionSubsidy })
        });
        loadActivities();
      }
    }

    async function logout() {
      await fetch("/logout");
      window.location.href = "/login.html";
    }

    loadCurrentUser();
    loadActivities();
  </script>
</body>
</html>
