<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>後台管理</title>
</head>
<body>
  <div style="display:flex; justify-content: space-between; align-items:center;">
    <h1>出納後台管理</h1>
    <div>
      <span id="currentUser"></span>
      <button onclick="logout()">登出</button>
      <button onclick="location.href='index.html'">返回首頁</button>
    </div>
  </div>

  <h2>用戶管理</h2>
  <div id="userForm" style="display:none;">
    <h3 id="userFormTitle">新增使用者</h3>
    <label>帳號: <input type="text" id="newUsername"></label><br><br>
    <label>密碼: <input type="password" id="newPassword"></label><br><br>
    <label>權限: 
      <select id="newRole">
        <option value="admin">admin</option>
        <option value="manager">管理員</option>
      </select>
    </label><br><br>
    <button onclick="submitUserForm()">確認</button>
    <button onclick="cancelUserForm()">取消</button>
  </div>

  <button id="showAddUserBtn" onclick="showAddUserForm()">新增使用者</button>
  <table id="usersTable">
    <thead>
      <tr><th>帳號</th><th>權限</th><th>操作</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const currentUser = JSON.parse(sessionStorage.getItem('user'));
document.getElementById('currentUser').innerText = `登入使用者：${currentUser.username} (${currentUser.role})`;

async function loadUsers(){
  const res = await fetch('/users');
  const users = await res.json();
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';

  users.forEach(u=>{
    const tr = document.createElement('tr');
    let ops = '';

    if(currentUser.role==='admin'){
      ops += `<button onclick="showChangePasswordForm('${u.username}')">修改密碼</button>`;
      if(u.username!=='admin'){ ops += ` <button onclick="deleteUser('${u.username}')">刪除</button>`; }
    } else if(currentUser.username === u.username){
      ops += `<button onclick="showChangePasswordForm('${u.username}')">修改密碼</button>`;
    }

    tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td><td>${ops}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('showAddUserBtn').style.display = (currentUser.role==='admin')?'inline-block':'none';
}

function showAddUserForm(){
  document.getElementById('userForm').style.display='block';
}

function cancelUserForm(){
  document.getElementById('userForm').style.display='none';
}

async function submitUserForm(){
  const username = document.getElementById('newUsername').value;
  const password = document.getElementById('newPassword').value;
  const role = document.getElementById('newRole').value;
  const res = await fetch('/users',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password,role})});
  const data = await res.json();
  alert(data.message);
  document.getElementById('userForm').style.display='none';
  loadUsers();
}

async function deleteUser(username){
  if(!confirm(`確定刪除 ${username} ?`)) return;
  const res = await fetch('/users/'+username,{method:'DELETE'});
  const data = await res.json();
  alert(data.message);
  loadUsers();
}

function logout(){
  fetch('/logout',{method:'POST'}).then(()=>location.href='index.html');
}

// 初始化
loadUsers();
</script>
</body>
</html>
