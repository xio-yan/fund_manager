<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>後台管理</title></head>
<body>
<h1>後台管理</h1>
<div>
<span id="currentUser"></span>
<button onclick="logout()">登出</button>
<button onclick="location.href='index.html'">返回首頁</button>
</div>

<h2>預支管理</h2>
<table id="advTable" border="1">
<thead><tr>
<th>ID</th><th>姓名</th><th>活動</th><th>申請日期</th><th>總金額</th><th>狀態</th><th>操作</th>
</tr></thead>
<tbody></tbody>
</table>

<script>
let currentUser = JSON.parse(sessionStorage.getItem('user'));
document.getElementById('currentUser').innerText = `登入使用者：${currentUser.username}`;

async function loadAdvances(){
  const res = await fetch('/advances');
  const advances = await res.json();
  const tbody = document.querySelector('#advTable tbody');
  tbody.innerHTML='';
  advances.forEach(a=>{
    let ops='';
    if(a.status==='pending') ops=`<button onclick="markPaid(${a.id})">給款</button>`;
    ops+=` <button onclick="repay(${a.id})">還款</button>`;
    tbody.innerHTML+=`<tr>
<td>${a.id}</td><td>${a.name}</td><td>${a.activity}</td><td>${a.apply_date}</td><td>${a.total_amount}</td><td>${a.status}</td><td>${ops}</td>
</tr>`;
  });
}

async function markPaid(id){ await fetch('/markPaid/'+id,{method:'POST'}); loadAdvances(); }

async function repay(id){
  const school = parseFloat(prompt('學校補助金額?'));
  const sc = parseFloat(prompt('學生會補助金額?'));
  const res = await fetch('/repay',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({advance_id:id, school_paid:school, student_council_paid:sc})
  });
  const data = await res.json();
  alert(`剩餘現金: ${data.remaining_cash}`);
  loadAdvances();
}

function logout(){ fetch('/logout',{method:'POST'}).then(()=>location.href='login.html'); }

loadAdvances();
</script>
</body>
</html>
