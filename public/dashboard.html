<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>後台管理</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { display: inline-block; }
    .user-info { float: right; font-weight: bold; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f2f2f2; }
    button { margin: 2px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>後台管理</h1>
  <div class="user-info">
    登入使用者：<span id="currentUser"></span> |
    <a href="/logout">登出</a> |
    <a href="/">返回首頁</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>申請人</th>
        <th>用途</th>
        <th>金額</th>
        <th>來源</th>
        <th>申請日期</th>
        <th>給款日期</th>
        <th>還款日期</th>
        <th>學校補助</th>
        <th>學生會補助</th>
        <th>應還現金</th>
        <th>狀態</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="recordsBody">
    </tbody>
  </table>

  <script>
    async function fetchRecords() {
      const res = await fetch('/api/advances');
      const records = await res.json();
      const tbody = document.getElementById('recordsBody');
      tbody.innerHTML = '';

      records.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.applicant}</td>
          <td>${r.description}</td>
          <td>${r.amount}</td>
          <td>${r.source}</td>
          <td>${r.applyDate || ''}</td>
          <td>${r.payDate || ''}</td>
          <td>${r.repayDate || ''}</td>
          <td>${r.schoolSubsidy}</td>
          <td>${r.studentUnionSubsidy}</td>
          <td>${r.cashReturn}</td>
          <td>${r.status}</td>
          <td>
            ${r.status === 'pending' ? `<button onclick="markPaid(${r.id})">已付款</button>` : ''}
            ${r.status === 'paid' ? `<button onclick="markRepaid(${r.id})">還款</button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function markPaid(id) {
      if (!confirm("確認這筆款項已付款？")) return;
      await fetch(`/api/advance/${id}/pay`, { method: 'POST' });
      fetchRecords();
    }

    async function markRepaid(id) {
      const school = prompt("請輸入學校補助金額：", "0");
      if (school === null) return;

      const union = prompt("請輸入學生會補助金額：", "0");
      if (union === null) return;

      const res = await fetch(`/api/advance/${id}/repay`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ schoolSubsidy: school, studentUnionSubsidy: union })
      });
      const data = await res.json();
      if (data.success) {
        alert(`還款完成，應還現金：${data.record.cashReturn} 元`);
      } else {
        alert("操作失敗：" + data.message);
      }
      fetchRecords();
    }

    async function fetchCurrentUser() {
      const res = await fetch('/api/current-user');
      const data = await res.json();
      document.getElementById('currentUser').innerText = data.username || '未知';
    }

    fetchRecords();
    fetchCurrentUser();
  </script>
</body>
</html>
