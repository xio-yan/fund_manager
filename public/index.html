<!DOCTYPE html>
<html>
<head>
  <title>經費預支系統</title>
</head>
<body>
  <h1>新增預支</h1>
  <form id="advanceForm">
    姓名: <input type="text" name="name" required><br>
    活動名稱: <input type="text" name="activity" required><br>
    <div id="items">
      <div>
        用途: <input type="text" name="description[]" required>
        金額: <input type="number" name="amount[]" required>
        來源:
        <select name="source[]">
          <option value="school">學校</option>
          <option value="student_council">學生會</option>
        </select>
      </div>
    </div>
    <button type="button" onclick="addItem()">新增用途</button><br><br>
    <button type="submit">送出</button>
  </form>

  <hr>
  <button onclick="window.location.href='/login.html'">前往後台</button>

  <script>
    function addItem() {
      const div = document.createElement('div');
      div.innerHTML = `用途: <input type="text" name="description[]" required>
        金額: <input type="number" name="amount[]" required>
        來源: <select name="source[]">
          <option value="school">學校</option>
          <option value="student_council">學生會</option>
        </select>`;
      document.getElementById('items').appendChild(div);
    }

    document.getElementById('advanceForm').addEventListener('submit', function(e){
      e.preventDefault();
      const formData = new FormData(e.target);
      const items = [];
      const descriptions = formData.getAll('description[]');
      const amounts = formData.getAll('amount[]');
      const sources = formData.getAll('source[]');
      for(let i=0;i<descriptions.length;i++){
        items.push({description: descriptions[i], amount: parseFloat(amounts[i]), source: sources[i]});
      }
      fetch('/advance', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({name: formData.get('name'), activity: formData.get('activity'), items})
      }).then(res=>res.json()).then(data=>{
        alert(JSON.stringify(data));
        e.target.reset(); // 送出後清空表單
        document.getElementById('items').innerHTML = `<div>
          用途: <input type="text" name="description[]" required>
          金額: <input type="number" name="amount[]" required>
          來源:
          <select name="source[]">
            <option value="school">學校</option>
            <option value="student_council">學生會</option>
          </select>
        </div>`;
      });
    });
  </script>
</body>
</html>
