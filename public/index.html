<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>經費預支登記</title>
</head>
<body>
  <h1>經費預支登記</h1>
  <form id="advanceForm">
    姓名：<input type="text" name="applicant" required><br>
    活動名稱：<input type="text" name="activityName" required><br>

    <div id="itemsContainer">
      <h3>款項明細</h3>
      <div class="item">
        用途：<input name="description" required>
        金額：<input type="number" name="amount" required>
        來源：
        <select name="source" required>
          <option value="學校">學校</option>
          <option value="學生會">學生會</option>
        </select>
        <button type="button" class="removeItem">刪除</button>
      </div>
    </div>
    <button type="button" id="addItem">新增款項</button><br><br>
    <button type="submit">送出申請</button>
  </form>
  <p id="message"></p>
  <br>
  <a href="/login.html">進入後台</a>

  <script>
    function addItem() {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        用途：<input name="description" required>
        金額：<input type="number" name="amount" required>
        來源：
        <select name="source" required>
          <option value="學校">學校</option>
          <option value="學生會">學生會</option>
        </select>
        <button type="button" class="removeItem">刪除</button>
      `;
      document.getElementById("itemsContainer").appendChild(div);

      div.querySelector(".removeItem").addEventListener("click", () => {
        div.remove();
      });
    }

    document.getElementById("addItem").addEventListener("click", addItem);

    // 刪除初始那筆
    document.querySelector(".removeItem").addEventListener("click", function() {
      this.parentElement.remove();
    });

    document.getElementById("advanceForm").addEventListener("submit", async e => {
      e.preventDefault();
      const applicant = e.target.applicant.value;
      const activityName = e.target.activityName.value;
      const items = Array.from(document.querySelectorAll(".item")).map(it => ({
        description: it.querySelector("[name='description']").value,
        amount: it.querySelector("[name='amount']").value,
        source: it.querySelector("[name='source']").value
      }));
      const res = await fetch("/api/activity", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ applicant, activityName, items })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById("message").innerText = "送出成功！";
        e.target.reset();
        document.getElementById("itemsContainer").innerHTML = `<h3>款項明細</h3>
        <div class="item">
          用途：<input name="description" required>
          金額：<input type="number" name="amount" required>
          來源：
          <select name="source" required>
            <option value="學校">學校</option>
            <option value="學生會">學生會</option>
          </select>
          <button type="button" class="removeItem">刪除</button>
        </div>`;
        document.querySelector(".removeItem").addEventListener("click", function() {
          this.parentElement.remove();
        });
      } else {
        document.getElementById("message").innerText = "送出失敗！";
      }
    });
  </script>
</body>
</html>
