<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>經費預支申請</title>
</head>
<body>
<h1>預支申請表</h1>
<label>姓名: <input id="name"></label><br>
<label>活動: <input id="activity"></label><br>

<div id="itemsContainer"><h3>項目</h3></div>
<button onclick="addItem()">新增項目</button><br><br>

<button onclick="submitAdvance()">送出預支</button>
<button onclick="location.href='login.html'">前往後台</button>

<script>
function addItem(){
  const container = document.getElementById('itemsContainer');
  const div = document.createElement('div');
  div.innerHTML = `
    項目名稱: <input class="itemName">
    金額: <input type="number" class="itemAmount">
    來源: <select class="itemSource"><option value="school">學校</option><option value="student_council">學生會</option></select>
    <button onclick="this.parentNode.remove()">刪除</button>
  `;
  container.appendChild(div);
}

async function submitAdvance(){
  const name = document.getElementById('name').value;
  const activity = document.getElementById('activity').value;
  const itemsDivs = document.querySelectorAll('#itemsContainer > div');
  const items = Array.from(itemsDivs).map(d=>({
    name:d.querySelector('.itemName').value,
    amount: parseFloat(d.querySelector('.itemAmount').value),
    source: d.querySelector('.itemSource').value
  }));
  if(!name || !activity || items.length===0){ alert('資料不完整'); return; }
  const res = await fetch('/advances',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name,activity,items})});
  const data = await res.json();
  alert(data.message);
  // 清空表單
  document.getElementById('name').value='';
  document.getElementById('activity').value='';
  document.getElementById('itemsContainer').innerHTML='<h3>項目</h3>';
}
</script>
</body>
</html>
